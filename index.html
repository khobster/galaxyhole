<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Space Cornhole - 2 Player</title>
  <style>
    /* Basic reset */
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }
    /* The main game container uses perspective */
    #game-container {
      width: 100vw;
      height: 100vh;
      background: linear-gradient(#87CEEB, #90EE90);
      position: relative;
      overflow: hidden;
      perspective: 1000px;
      perspective-origin: 50% 75%;
    }
    /* The 3D scene holding board and bags */
    #scene {
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      position: absolute;
      top: 0;
      left: 0;
      transform: rotateX(45deg);
    }
    /* The board – now placed further back */
    #board {
      position: absolute;
      width: 120px;
      height: 240px;
      left: 50%;
      top: 25%;
      transform-style: preserve-3d;
      transform-origin: center bottom;
      transform: translate(-50%, -50%) translateZ(-300px);
      background: #8B4513;
      border: 4px solid #654321;
      border-radius: 4px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    #hole {
      position: absolute;
      width: 30px;
      height: 30px;
      left: 50%;
      top: 25%;
      transform: translate(-50%, -50%);
      background: #000;
      border-radius: 50%;
    }
    /* Each bag element – note we create new ones per throw */
    .bag {
      position: absolute;
      width: 40px;
      height: 40px;
      background: #c41e3a;
      border-radius: 5px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
      z-index: 10;
    }
    /* The trail particles follow in the same 3D space */
    #trajectory {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      top: 0;
      left: 0;
      z-index: 1;
    }
    .trail-particle {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 3px;
      opacity: 0;
      animation: fadeOut 0.6s forwards;
      pointer-events: none;
    }
    @keyframes fadeOut {
      0%   { opacity: 0.8; }
      100% { opacity: 0; }
    }
    /* A visible counter for the throw number */
    #tryCounter {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 24px;
      background: rgba(255,255,255,0.8);
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 100;
    }
    /* Controls for Firebase game creation/joining & throwing */
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 100;
    }
    button {
      background: #c41e3a;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      text-transform: uppercase;
      user-select: none;
      transition: transform 0.1s, background 0.2s;
    }
    button:hover { background: #d42e4a; }
    button:active { transform: scale(0.95); }
    input[type="text"] {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
  </style>
  <!-- Firebase scripts (v8) from the CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <div id="game-container">
    <div id="scene">
      <!-- Trail particles will be appended here -->
      <div id="trajectory"></div>
      <div id="board">
        <div id="hole"></div>
      </div>
      <!-- Bags will be added dynamically into the scene -->
    </div>
    <div id="tryCounter">Waiting for game...</div>
    <div id="controls">
      <!-- The throw button is enabled only on the local player's turn -->
      <button id="throw-button" disabled>Hold to Throw</button>
      <button id="create-game">Create Game</button>
      <input type="text" id="gameIdInput" placeholder="Game ID">
      <button id="join-game">Join Game</button>
    </div>
  </div>

<script>
/********************************************************
 * Firebase Initialization and Two-Player Game Logic
 ********************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyDicI1nKcrMDaaYkL_8q70yj1mM05tW5Ak",
  authDomain: "mookie-pig-challenge.firebaseapp.com",
  projectId: "mookie-pig-challenge",
  storageBucket: "mookie-pig-challenge.appspot.com",
  messagingSenderId: "96530997300",
  appId: "1:96530997300:web:96400cf87b98c8e19eaa61",
  measurementId: "G-NJQ84VFPYK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Global game state variables
let gameId = null;
let currentPlayer; // Indicates whose turn it is: 1 or 2.
let localPlayerNum = null; // 1 or 2 for the local client.
const totalThrows = 4;  // Each player gets four throws.
let player1Throws = 0, player2Throws = 0;
const playerId = generatePlayerId();

// UI elements for game control and try counter
const throwBtn = document.getElementById('throw-button');
const tryCounterEl = document.getElementById('tryCounter');
const createGameBtn = document.getElementById('create-game');
const joinGameBtn = document.getElementById('join-game');
const gameIdInput = document.getElementById('gameIdInput');

// Create a new game: local player becomes Player 1.
function createNewGame() {
  db.collection('cornholeGames').add({
    player1Id: playerId,
    player2Id: null,
    currentPlayer: 1,
    player1Throws: 0,
    player2Throws: 0,
    gameStatus: 'waiting'
  }).then(docRef => {
    gameId = docRef.id;
    localPlayerNum = 1;
    alert("Game created. Share this Game ID with your friend: " + gameId);
    startGameListener();
  }).catch(err => {
    console.error("Error creating game", err);
  });
}

// Join an existing game: local player becomes Player 2.
function joinGame(gameIdToJoin) {
  gameId = gameIdToJoin;
  const gameRef = db.collection('cornholeGames').doc(gameId);
  gameRef.get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      if (!data.player2Id && data.player1Id !== playerId) {
        return gameRef.update({
          player2Id: playerId,
          gameStatus: 'started'
        }).then(() => {
          localPlayerNum = 2;
          startGameListener();
        });
      } else if (data.player1Id === playerId || data.player2Id === playerId) {
        // Already in this game.
        localPlayerNum = (data.player1Id === playerId) ? 1 : 2;
        startGameListener();
      } else {
        alert("Unable to join game. It may already be full.");
      }
    } else {
      alert("Game not found.");
    }
  }).catch(err => console.error("Error joining game", err));
}

// Listen to game document updates and update the UI accordingly.
function startGameListener() {
  const gameRef = db.collection('cornholeGames').doc(gameId);
  gameRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      currentPlayer = data.currentPlayer;
      player1Throws = data.player1Throws;
      player2Throws = data.player2Throws;
      updateTryCounter();
      // Enable the throw button only if it’s our turn and the game is active.
      if (localPlayerNum === currentPlayer && data.gameStatus === 'started') {
        throwBtn.disabled = false;
      } else {
        throwBtn.disabled = true;
      }
      // Optionally, you could update on-screen bag positions from other players here.
    }
  });
}

// Update the try counter display.
function updateTryCounter() {
  let myThrows = (localPlayerNum === 1) ? player1Throws : player2Throws;
  tryCounterEl.textContent = `Player ${localPlayerNum} - Try ${myThrows + 1} of ${totalThrows}`;
}

/********************************************************
 * Cornhole Simulation Code (Physics, Trail, Bag Creation)
 ********************************************************/
const sceneEl = document.getElementById('scene');
const trajectoryContainer = document.getElementById('trajectory');
const holeEl = document.getElementById('hole');
let isAnimating = false;
let throwStartTime = 0;
let currentBagEl = null;

// Create a new bag element and position it at the "player's hand."
function createBagElement() {
  const bag = document.createElement('div');
  bag.classList.add('bag');
  sceneEl.appendChild(bag);
  setBagStartPosition(bag);
  return bag;
}
function setBagStartPosition(bag) {
  const gameW = window.innerWidth;
  const gameH = window.innerHeight;
  const bagWidth = 40, bagHeight = 40;
  const startX = gameW * 0.5;
  const startY = gameH - bagHeight - 20;
  const startZ = 0;
  bag.style.transform = `translate3d(${startX - bagWidth/2}px, ${startY - bagHeight/2}px, ${startZ}px)`;
}

// Start timing the throw (on mousedown/touchstart).
function startThrow(e) {
  e.preventDefault();
  if (isAnimating || !currentBagEl) return;
  throwStartTime = performance.now();
}
// Release the throw (on mouseup/touchend) and calculate throw power.
function releaseThrow(e) {
  e.preventDefault();
  if (isAnimating || throwStartTime === 0) return;
  const holdTime = performance.now() - throwStartTime;
  const throwPower = Math.min(100, holdTime / 20);
  doThrow(throwPower);
  throwStartTime = 0;
}

// Animate the bag along a 3D parabolic path.
function doThrow(power) {
  if (isAnimating || !currentBagEl) return;
  isAnimating = true;
  
  const gameW = window.innerWidth;
  const gameH = window.innerHeight;
  const bagWidth = 40, bagHeight = 40;
  
  // Starting position (player's hand)
  const startX = gameW * 0.5;
  const startY = gameH - bagHeight - 20;
  const startZ = 0;
  // Target on (or near) the board. Adjust these values as needed.
  const targetX = gameW * 0.5;
  const targetY = gameH * 0.40;
  const targetZ = -280;
  
  const optimalPower = 50;
  const baseArc = 100;
  const arcHeight = baseArc * (power / optimalPower);
  const flightTime = 2000; // milliseconds
  const startTime = performance.now();
  
  function animateFrame(now) {
    let t = (now - startTime) / flightTime;
    if (t > 1) t = 1;
    // Scale the normalized time (u) based on power so that too little/much force changes the landing.
    let u = t * (power / optimalPower);
    const x = startX + (targetX - startX) * u;
    const z = startZ + (targetZ - startZ) * u;
    const linearY = startY + (targetY - startY) * u;
    // A parabolic adjustment in y (peak at u = 0.5)
    const y = linearY - arcHeight * 4 * u * (1 - u);
    
    currentBagEl.style.transform = `translate3d(${x - bagWidth/2}px, ${y - bagHeight/2}px, ${z}px)`;
    
    // Create trail particles (using the current x,y,z)
    if ((now - startTime) % 40 < 20) {
      createTrailParticle(x, y, z);
    }
    
    if (t < 1) {
      requestAnimationFrame(animateFrame);
    } else {
      // When done, update the game state.
      finishThrow();
      isAnimating = false;
    }
  }
  requestAnimationFrame(animateFrame);
}

// When a throw animation finishes, update Firebase and create a new bag (if needed).
function finishThrow() {
  const gameRef = db.collection('cornholeGames').doc(gameId);
  if (localPlayerNum === 1) {
    gameRef.update({
      player1Throws: firebase.firestore.FieldValue.increment(1)
    }).then(() => {
      // After incrementing, check if player 1 is done.
      if (player1Throws + 1 >= totalThrows) {
        // If player 2 is already done, end the game; otherwise, switch turn.
        gameRef.get().then(doc => {
          const data = doc.data();
          if (data.player2Throws >= totalThrows) {
            gameRef.update({gameStatus: 'ended'});
            alert("Game over!");
          } else {
            gameRef.update({currentPlayer: 2});
          }
        });
      }
    });
  } else {
    gameRef.update({
      player2Throws: firebase.firestore.FieldValue.increment(1)
    }).then(() => {
      if (player2Throws + 1 >= totalThrows) {
        gameRef.get().then(doc => {
          const data = doc.data();
          if (data.player1Throws >= totalThrows) {
            gameRef.update({gameStatus: 'ended'});
            alert("Game over!");
          } else {
            gameRef.update({currentPlayer: 1});
          }
        });
      }
    });
  }
  
  // Leave the thrown bag on the board.
  // If the local player still has throws remaining, create a new bag.
  const myThrows = (localPlayerNum === 1) ? player1Throws : player2Throws;
  if (myThrows + 1 < totalThrows) {
    currentBagEl = createBagElement();
  } else {
    currentBagEl = null;
  }
}

// Create a small trail particle at the given 3D position.
function createTrailParticle(x, y, z) {
  const p = document.createElement('div');
  p.className = 'trail-particle';
  p.style.background = '#c41e3a';
  p.style.boxShadow = '0 0 8px #c41e3a';
  p.style.transform = `translate3d(${x - 4}px, ${y - 4}px, ${z}px)`;
  p.style.zIndex = 5;
  trajectoryContainer.appendChild(p);
  setTimeout(() => p.remove(), 800);
}

/********************************************************
 * Event Listeners and Utility Functions
 ********************************************************/
// Initialize the first bag (but note: the throw button is enabled only on our turn)
currentBagEl = createBagElement();
throwBtn.addEventListener('mousedown', startThrow);
throwBtn.addEventListener('mouseup', releaseThrow);
throwBtn.addEventListener('touchstart', startThrow);
throwBtn.addEventListener('touchend', releaseThrow);

createGameBtn.addEventListener('click', () => {
  createNewGame();
});
joinGameBtn.addEventListener('click', () => {
  const joinId = gameIdInput.value.trim();
  if (joinId) {
    joinGame(joinId);
  }
});

// Utility: Generate (and store) a unique playerId.
function generatePlayerId() {
  let stored = localStorage.getItem('playerId');
  if (stored) return stored;
  let newId = Math.random().toString(36).substr(2, 9);
  localStorage.setItem('playerId', newId);
  return newId;
}
</script>
</body>
</html>
