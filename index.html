<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Space Cornhole — Multiplayer v2</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:linear-gradient(#87CEEB 0%,#90EE90 100%);overflow:hidden}
    .screen{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;gap:1rem}
    #setup{display:flex}
    button{padding:.6rem 1.2rem;border:none;border-radius:.5rem;font-weight:600;color:#fff;background:#c41e3a;cursor:pointer}button:hover{background:#d42e4a}
    select,input{padding:.4rem .8rem;border:2px solid #444;border-radius:.4rem;font:inherit}
    #board{position:absolute;width:120px;height:240px;left:50%;top:45%;transform:translate(-50%,-50%);background:#8B4513;border:4px solid #654321;border-radius:4px;box-shadow:0 20px 40px #0005;}
    #hole{position:absolute;width:38px;height:38px;left:50%;top:25%;transform:translate(-50%,-50%);border-radius:50%;background:#000;box-shadow:inset 0 0 10px #0008}
    .bag{position:absolute;width:40px;height:40px;border-radius:5px;background:var(--clr);box-shadow:0 5px 10px #0004;will-change:transform}
    .shadow{position:absolute;width:40px;height:15px;border-radius:50%;background:#0003;will-change:transform;pointer-events:none}
    #hud{position:absolute;inset:0;pointer-events:none;display:flex;flex-direction:column;align-items:center;gap:.4rem}
    #scores,#turn,#planet{background:#ffffffcc;padding:.25rem .8rem;border-radius:.4rem;font-weight:700;pointer-events:auto}
    #planet{top:.5rem;position:absolute;left:50%;transform:translateX(-50%);font-weight:600}
  </style>
</head>
<body>
  <div id="setup" class="screen">
    <h1>Space Cornhole</h1>
    <label>Gravity:
      <select id="planetSel">
        <option value="earth">Earth (9.8)</option>
        <option value="moon">Moon (1.6)</option>
        <option value="mars">Mars (3.7)</option>
        <option value="jupiter">Jupiter (24.8)</option>
      </select></label>
    <button id="create">Create</button>
    <input id="joinId" placeholder="Game ID" />
    <button id="join">Join</button>
  </div>

  <div id="wait" class="screen">
    <p>Share the link:</p>
    <div style="display:flex;gap:.5rem"><input id="link" readonly style="width:340px"/><button id="copy">Copy</button></div>
    <p id="waitMsg">Waiting…</p>
  </div>

  <div id="game" class="screen">
    <div id="planet"></div>
    <div id="hud"><div id="scores">0 – 0</div><div id="turn"> </div></div>
    <div id="board"><div id="hole"></div></div>
  </div>

  <div id="result" class="screen"><h2 id="msg"></h2><button id="again">Play Again</button></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
// ── Firebase config (keep as‑is) ────────────────────────────────────────────────
const firebaseConfig={apiKey:"AIzaSyBMuOpUCgNHUkccH_ENPE9l-iQApvdHtA4",authDomain:"galaxy-hole-53c76.firebaseapp.com",projectId:"galaxy-hole-53c76",storageBucket:"galaxy-hole-53c76.appspot.com",messagingSenderId:"592610380036",appId:"1:592610380036:web:4b5c72ee181682b9262851"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// ── Physics presets ────────────────────────────────────────────────────────────
const planets={earth:{g:9.8,scale:1},moon:{g:1.6,scale:.45},mars:{g:3.7,scale:.7},jupiter:{g:24.8,scale:1.4}};
let planet=planets.earth;

// ── Basic state ────────────────────────────────────────────────────────────────
let gameId=null,me=null,turn=1,throws={1:0,2:0},score={1:0,2:0};
const MAX=4,WIN=21;
const pid=(()=>{let v=localStorage.pid;if(!v){v=Math.random().toString(36).slice(2,9);localStorage.pid=v;}return v})();

// ── DOM helpers ────────────────────────────────────────────────────────────────
const $=id=>document.getElementById(id);const screens={setup:$('setup'),wait:$('wait'),game:$('game'),result:$('result')};
const show=scr=>Object.values(screens).forEach(s=>s.style.display=s===scr?'flex':'none');
show(screens.setup);

// ── UI actions ────────────────────────────────────────────────────────────────
$('planetSel').onchange=e=>planet=planets[e.target.value];
$('copy').onclick=()=>navigator.clipboard.writeText($('link').value);
$('again').onclick=()=>location.href=location.pathname;

$('create').onclick=async()=>{const doc=await db.collection('cornhole').add({p1:pid,p2:null,planet:$('planetSel').value,st:'wait',turn:1,sc:{1:0,2:0},th:{1:0,2:0},bags:{1:[],2:[]}});gameId=doc.id;me=1;planet=planets[$('planetSel').value];$('link').value=`${location.origin}${location.pathname}?id=${gameId}`;show(screens.wait);listen();};
$('join').onclick=()=>join($('joinId').value.trim());
async function join(id){if(!id)return;gameId=id;me=2;const ref=db.collection('cornhole').doc(id);const snap=await ref.get();if(!snap.exists){alert('Not found');return;}const d=snap.data();if(d.p2&&d.p2!==pid){alert('Full');return;}await ref.update({p2:pid,st:'play'});listen();}
const qp=new URLSearchParams(location.search);if(qp.has('id'))join(qp.get('id'));

// ── Firestore listener ────────────────────────────────────────────────────────
function listen(){db.collection('cornhole').doc(gameId).onSnapshot(snap=>{if(!snap.exists)return;const d=snap.data();planet=planets[d.planet];turn=d.turn;throws=d.th;score=d.sc;updateUI(d.st,d.bags);});}

// ── UI refresh ────────────────────────────────────────────────────────────────
function updateUI(st,bags){$('scores').textContent=`${score[1]} – ${score[2]}`;$('turn').textContent=turn===me?'Your turn':'Opponent';$('planet').textContent=`Gravity: ${Object.keys(planets).find(k=>planets[k]===planet)}`;
  if(st==='wait'){show(me===1?screens.wait:screens.game);}else if(st==='play'){show(screens.game);if(turn===me&&throws[me]<MAX)spawnBag();}else if(st==='end'){show(screens.result);$('msg').textContent=score[me]>score[3-me]?'You win!':'You lose!';}
}

// ── BAG DRAG & THROW ──────────────────────────────────────────────────────────
let bag,shadow,start;
function spawnBag(){bag=document.createElement('div');bag.className='bag';bag.style.setProperty('--clr',me===1?'#c41e3a':'#4287f5');shadow=document.createElement('div');shadow.className='shadow';document.body.append(bag,shadow);place();document.addEventListener('pointerdown',dragStart,{once:true});}
function place(){bag.style.transform=`translate(${innerWidth/2-20}px,${innerHeight-130}px)`;shadow.style.transform=`translate(${innerWidth/2-20}px,${innerHeight-90}px)`;}
function dragStart(e){start={x:e.clientX,y:e.clientY,t:performance.now()};document.addEventListener('pointermove',dragMove);document.addEventListener('pointerup',dragEnd,{once:true});}
function dragMove(e){const dx=e.clientX-start.x,dy=e.clientY-start.y;bag.style.transform=`translate(${innerWidth/2-20+dx/3}px,${innerHeight-130+dy/3}px)`;shadow.style.transform=`translate(${innerWidth/2-20+dx/3}px,${innerHeight-90})`;} // shadow stays ground
function dragEnd(e){document.removeEventListener('pointermove',dragMove);
  const dx=e.clientX-start.x,dy=start.y-e.clientY;const dist=Math.hypot(dx,dy);if(dist<20){place();document.addEventListener('pointerdown',dragStart,{once:true});return;}
  const t=(performance.now()-start.t)/1000;const power=dist/t*planet.scale*0.35;throwBag(dx,dy,power);} // tuned factor

function throwBag(dx,dy,pwr){const dirX=dx/dist(dx,dy),dirY=dy/dist(dx,dy);const vx=dirX*pwr,vy=dirY*pwr;const g=planet.g*window.innerHeight/7;const sx=parseFloat(bag.style.transform.split('(')[1]);const sy=parseFloat(bag.style.transform.split(',')[1]);let t0=performance.now();
  (function anim(now){const t=(now-t0)/1000;const x=sx+vx*t;const y=sy-vy*t+0.5*g*t*t;bag.style.transform=`translate(${x}px,${y}px)`;shadow.style.transform=`translate(${x}px,${innerHeight-90}px)`;if(y<innerHeight-40){requestAnimationFrame(anim);}else{finish(x+20,y+20);bag.remove();shadow.remove();}})(performance.now());
  function dist(a,b){return Math.hypot(a,b);} // helper
}

// ── FINISH & SCORE ────────────────────────────────────────────────────────────
function finish(cx,cy){const br=$('#board').getBoundingClientRect(),hr=$('#hole').getBoundingClientRect();let pts=0;if(Math.hypot(cx-(hr.left+hr.width/2),cy-(hr.top+hr.height/2))<hr.width/2)pts=3;else if(cx>br.left&&cx<br.right&&cy>br.top&&cy<br.bottom)pts=1;
  db.runTransaction(async tx=>{const ref=db.collection('cornhole').doc(gameId);const snap=await tx.get(ref);const d=snap.data();d.bags[me].push({pts});d.th[me]++;if(d.th[1]>=MAX&&d.th[2]>=MAX)scoreRound(d);else d.turn=3-d.turn;d.st='play';tx.set(ref,d);});}
function scoreRound(d){const p1=d.bags[1].reduce((s,b)=>s+b.pts,0);const p2=d.bags[2].reduce((s,b)=>s+b.pts,0);const diff=Math.abs(p1-p2);if(p1>p2)d.sc[1]+=diff;else if(p2>p1)d.sc[2]+=diff;d.bags={1:[],2:[]};d.th={1:0,2:0};d.turn=1;if(d.sc[1]>=WIN||d.sc[2]>=WIN)d.st='end';}
</script>
</body>
</html>
